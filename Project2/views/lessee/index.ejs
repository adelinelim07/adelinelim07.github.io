<!DOCTYPE html>
<html>
    <head>
        <% include ../partials/head.ejs %>
    </head>
    <body>
        <% include ../partials/navbar.ejs %>

        <!--header-->
        <div class="Header-banner">
            <h1 id="header">Lessees</h1>
        </div>
        <!--end of header-->
        
        <!--start of dashboard page-->
        <div class="container">
        
        <!--lessee table-->
            <div class="portfolioTable-box">
                <table id="allAircraftTable" style="width:100%">
                    <thead>
                        <tr>
                            <th style= "width:120px">Lessee</th>
                            <th style= "width:280px">Country</th>
                            <th style= "width:190px">Credit Rating</th>
                            <th style= "width:190px"># Aircraft</th>
                            
                        
                        </tr>
                    </thead>
                    <tbody>

                        <% for (let i=0; i < lessee.length; i++){ %>
                        <tr>
                            <td style= "width:120px"><a href="/lessee/<%=lessee[i].id%>"><%=lessee[i].name%></a></td>
                            <td style= "width:280px"><%=lessee[i].country%></td>
                            <td style= "width:190px"><%=lessee[i].credit_rating%></td>
                            <td style= "width:190px"><%=lessee[i].aircraft.length%></td>
                            
                            
                        </tr>
                        <% } %>
                    </tbody>
                </table>
                
            </div>
            <!--HbarChart-->
            <div class="lesseeConc-box">
                <h2>Top 5 Lessees</h2>
                <p style="text-align:center">by NBV(US$'m)</p></br>
                <div class="lesseeConc-chartContainer">
                    <canvas id="lesseeConcChart">
                    </canvas>
                </div>
            </div>
            <!--pieChart-->
            <div class="country-box">
                <h2>Top 5 Countries</h2>
                <p style="text-align:center">by NBV(US$'m)</p></br>
                <div class="country-chartContainer">
                    <canvas id="countryChart">
                    </canvas>
                </div>
               
            </div>
            

        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <script src="/all.js"></script>
        <script type="text/javascript">
            let allData = <%-JSON.stringify(lessee)%>;
            let total = allData.length;
            //console.log(allData);
            //console.log(allData[0].name);

            let X_lessee= [];
            let X_country= [];
            let Y_sumNBV= [];
            let sumNBV = 0;

            for (let i=0; i<allData.length; i++){
                sumNBV=0; 
                for (let j=0; j<allData[i].aircraft.length; j++){
                    sumNBV += allData[i].aircraft[j].accounting.nbv /1000000;
                }
                Y_sumNBV.push(sumNBV);
            }

            var conc = [];
            for (let i=0; i<allData.length; i++){
                conc.push({'lessee': allData[i].name, 'country': allData[i].country, 'nbv':Y_sumNBV[i] })
            }

            conc.sort(function(a,b){
                return ((a.nbv > b.nbv)? -1: ((a.nbv == b.nbv) ? 0:1 ));
            })

            console.log(conc);

            for (let i=0; i<conc.length; i++){
                X_lessee.push(conc[i].lessee);
                Y_sumNBV[i] = conc[i].nbv ; 
            }

            plotHBarChart((Y_sumNBV.slice(0,5)),(X_lessee.slice(0,5)),'lesseeConcChart');

            //plotCountryConc

            var countryConc = {};
            conc.forEach(function(x,i){
                countryConc[x.country] = (countryConc[x.country] ||0 ) + parseInt(conc[i].nbv);
            });
            console.log(countryConc);
            let sortedCountryConc = Object.entries(countryConc).sort((a,b) => b[1] - a[1]);
            sortedCountryConc = sortedCountryConc.slice(0,5);
            
            let Y_countryNBV = [];
            for (let i=0; i<sortedCountryConc.length; i++){
                X_country.push(sortedCountryConc[i][0]);
                Y_countryNBV.push(sortedCountryConc[i][1]);
            };

            plotPieChart(Y_countryNBV,X_country,'countryChart');
        
       </script>
    </body>
</html>